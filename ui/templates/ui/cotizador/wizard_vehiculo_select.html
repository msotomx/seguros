{% extends "ui/base.html" %}
{% block title %}Nueva Cotización · Vehículo{% endblock %}

{% block content %}
<div class="d-flex align-items-center justify-content-between mb-3">
  <div>
    <h3 class="mb-0">Nueva Cotización</h3>
    <div class="text-muted">Paso 3 · Seleccionar vehículo (Individual)</div>
    <div class="text-muted small">Cliente: <b>{{ cliente }}</b></div>
  </div>
  <div class="d-flex gap-2">
    <a class="btn btn-outline-secondary" href="{% url 'ui:cotizacion_new_tipo' %}">Atrás</a>
    <a class="btn btn-outline-secondary" href="{% url 'ui:dashboard' %}">Cancelar</a>
  </div>
</div>

<ul class="nav nav-tabs mb-3">
  <li class="nav-item">
    <a class="nav-link {% if tab == 'mis' %}active{% endif %}"
       href="?tab=mis&q={{ q|urlencode }}">Mis vehículos</a>
  </li>
  <li class="nav-item">
    <a class="nav-link {% if tab == 'catalogo' %}active{% endif %}"
       href="?tab=catalogo&q={{ q|urlencode }}">Catálogo global</a>
  </li>
</ul>

<form method="get" class="card card-body mb-3">
  <input type="hidden" name="tab" value="{{ tab }}">
  <div class="row g-2 align-items-center">
    <div class="col-12 col-md-8">
      <input class="form-control" name="q" value="{{ q }}"
             placeholder="{% if tab == 'mis' %}Buscar por placas, VIN, marca, año...{% else %}Buscar por marca, submarca, año, AMIS...{% endif %}">
    </div>
    <div class="col-12 col-md-4 d-grid">
      <button class="btn btn-outline-secondary">Buscar</button>
    </div>
  </div>
</form>

{% if tab == "mis" %}
  <div class="card shadow-sm">
    <div class="table-responsive">
      <table class="table table-hover align-middle mb-0">
        <thead class="table-light">
          <tr>
            <th>Vehículo</th>
            <th>Placas</th>
            <th>VIN</th>
            <th>Uso</th>
            <th class="text-end">Acción</th>
          </tr>
        </thead>
        <tbody>
          {% for v in mis_vehiculos %}
            <tr>
              <td class="fw-semibold">
                {% if v.catalogo %}
                  {{ v.catalogo.marca.nombre }} {{ v.catalogo.submarca.nombre }} {{ v.catalogo.anio }}
                  {% if v.catalogo.version %}<div class="text-muted small">{{ v.catalogo.version }}</div>{% endif %}
                {% else %}
                  {{ v.marca_texto }} {{ v.submarca_texto }} {{ v.modelo_anio }}
                {% endif %}
              </td>
              <td>{{ v.placas|default:"-" }}</td>
              <td>{{ v.vin|default:"-" }}</td>
              <td>{{ v.get_tipo_uso_display }}</td>
              <td class="text-end">
                <form method="post" class="d-inline">
                  {% csrf_token %}
                  <input type="hidden" name="action" value="select_vehiculo">
                  <input type="hidden" name="vehiculo_id" value="{{ v.id }}">
                  <button class="btn btn-sm btn-primary">Seleccionar</button>
                </form>
              </td>
            </tr>
          {% empty %}
            <tr>
              <td colspan="5" class="text-center text-muted py-4">
                No hay vehículos registrados para este cliente.
                <div class="mt-2">
                  Cambia a <b>Catálogo global</b> para crear uno rápido.
                </div>
              </td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>

{% else %}

  <div class="card shadow-sm">
    <div class="table-responsive">
      <table class="table table-hover align-middle mb-0">
        <thead class="table-light">
          <tr>
            <th>Catálogo</th>
            <th>AMIS</th>
            <th>Tipo</th>
            <th class="text-end">Crear para cliente</th>
          </tr>
        </thead>
        <tbody>
          {% for c in catalogo_vehiculos %}
            <tr>
              <td class="fw-semibold">
                {{ c.marca.nombre }} {{ c.submarca.nombre }} {{ c.anio }}
                {% if c.version %}<div class="text-muted small">{{ c.version }}</div>{% endif %}
              </td>
              <td>{{ c.clave_amis|default:"-" }}</td>
              <td>{{ c.tipo_vehiculo|default:"-" }}</td>
              <td class="text-end">
                {% if can_create_vehiculo %}
                  <form method="post" class="d-inline">
                    {% csrf_token %}
                    <input type="hidden" name="action" value="create_from_catalogo">
                    <input type="hidden" name="catalogo_id" value="{{ c.id }}">

                    <select name="tipo_uso" class="form-select form-select-sm d-inline" style="width:auto;">
                      {% for val, label in tipo_uso_choices %}
                        <option value="{{ val }}">{{ label }}</option>
                      {% endfor %}
                    </select>

                    <input name="placas" class="form-control form-control-sm d-inline"
                           style="width:120px;" placeholder="Placas">
                    <input name="vin" class="form-control form-control-sm d-inline"
                           style="width:160px;" placeholder="VIN">
                    <button class="btn btn-sm btn-primary">Crear</button>
                  </form>
                {% else %}
                  <span class="text-muted small">Sin permiso</span>
                {% endif %}
              </td>
            </tr>
          {% empty %}
            <tr>
              <td colspan="4" class="text-center text-muted py-4">
                No se encontraron vehículos en catálogo.
              </td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>

  <div class="mt-2 text-muted small">
    Al crear desde catálogo, se genera un <b>Vehículo del cliente</b> enlazado a este catálogo y queda seleccionado automáticamente.
  </div>

{% endif %}
{% endblock %}
