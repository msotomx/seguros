{% extends "ui/base.html" %}
{% load humanize %}

{% block content %}
<div class="container py-4">

  <!-- Header -->
  <div class="d-flex flex-wrap align-items-center justify-content-between gap-2 mb-3">
    <div>
      <h3 class="mb-0">P√≥lizas</h3>
      <div class="text-muted small">
        {% if page_obj %}
          Mostrando {{ page_obj.start_index }}‚Äì{{ page_obj.end_index }} de {{ page_obj.paginator.count }}
        {% else %}
          {{ polizas|length }} registro(s)
        {% endif %}
      </div>
    </div>

    <div class="d-flex gap-2">
      <a href="{% url 'ui:cotizacion_new_cliente' %}" class="btn btn-outline-primary">
        <i class="bi bi-plus-lg me-1"></i> Nueva cotizaci√≥n
      </a>
      <a href="{% url 'ui:poliza_list' %}" class="btn btn-outline-secondary">
        <i class="bi bi-arrow-clockwise me-1"></i> Limpiar
      </a>
    </div>
  </div>

  <!-- Filters -->
  <div class="card shadow-sm mb-3">
    <div class="card-body">
      <form method="get" class="row g-2 align-items-end">
        <div class="col-12 col-lg-4">
          <label class="form-label">Buscar</label>
          <div class="input-group">
            <span class="input-group-text"><i class="bi bi-search"></i></span>
            <input
              type="text"
              name="q"
              class="form-control"
              placeholder="No. p√≥liza, cliente o RFC‚Ä¶"
              value="{{ filters.q|default:'' }}"
            >
          </div>
        </div>

        <div class="col-12 col-sm-6 col-lg-2">
          <label class="form-label">Estatus</label>
          <select name="estatus" class="form-select">
            <option value="">Todos</option>
            {% if estatus_choices %}
              {% for value,label in estatus_choices %}
                <option value="{{ value }}" {% if filters.estatus == value %}selected{% endif %}>{{ label }}</option>
              {% endfor %}
            {% else %}
              <!-- fallback por si no mandas choices -->
              <option value="EN_PROCESO" {% if filters.estatus == "EN_PROCESO" %}selected{% endif %}>En proceso</option>
              <option value="VIGENTE" {% if filters.estatus == "VIGENTE" %}selected{% endif %}>Vigente</option>
              <option value="VENCIDA" {% if filters.estatus == "VENCIDA" %}selected{% endif %}>Vencida</option>
              <option value="CANCELADA" {% if filters.estatus == "CANCELADA" %}selected{% endif %}>Cancelada</option>
            {% endif %}
          </select>
        </div>

        <div class="col-12 col-sm-6 col-lg-2">
          <label class="form-label">Desde (emisi√≥n)</label>
          <input type="date" name="desde" class="form-control" value="{{ filters.desde|default:'' }}">
        </div>

        <div class="col-12 col-sm-6 col-lg-2">
          <label class="form-label">Hasta (emisi√≥n)</label>
          <input type="date" name="hasta" class="form-control" value="{{ filters.hasta|default:'' }}">
        </div>

        <div class="col-12 col-sm-6 col-lg-2 d-grid">
          <button class="btn btn-primary" type="submit">
            <i class="bi bi-funnel me-1"></i> Filtrar
          </button>
        </div>
      </form>

      <div class="small text-muted mt-2">
        Tip: ‚ÄúEmisi√≥n‚Äù se llena cuando la p√≥liza pasa a <strong>Vigente</strong>; si est√° <strong>En proceso</strong> puede salir en blanco.
      </div>
    </div>
  </div>

  <!-- List -->
  <div class="card shadow-sm">
    <div class="card-body p-0">

      {% if polizas %}
      <div class="table-responsive">
        <table class="table table-hover align-middle mb-0">
          <thead class="table-light">
            <tr>
              <th class="ps-3">No. p√≥liza</th>
              <th>Cliente</th>
              <th>Emisi√≥n</th>
              <th>Vigencia</th>
              <th class="text-end">Prima</th>
              <th>Estatus</th>
              <th class="text-end pe-3">Acciones</th>
            </tr>
          </thead>

          <tbody>
            {% for p in polizas %}
              <tr>
                <td class="ps-3">
                  <a href="{% url 'ui:poliza_detail' p.pk %}" class="text-decoration-none fw-semibold">
                    {{ p.numero_poliza }}
                  </a>
                  <div class="text-muted small">
                    {{ p.aseguradora.nombre }} ‚Ä¢ {{ p.producto.nombre }}
                  </div>
                </td>

                <td>
                  <div class="fw-semibold">{{ p.cliente.nombre_mostrar|truncatechars:25 }}</div>
                  <div class="text-muted small">
                    {% if p.vehiculo %}
                      {{ p.vehiculo }}
                    {% elif p.flotilla %}
                      Flotilla: {{ p.flotilla.nombre|default:p.flotilla }}
                    {% else %}
                      ‚Äî
                    {% endif %}
                  </div>
                </td>

                <td>
                  {% if p.fecha_emision %}
                    <span class="fw-semibold">{{ p.fecha_emision|date:"d/M/Y" }}</span>
                  {% else %}
                    <span class="text-muted">‚Äî</span>
                  {% endif %}
                </td>

                <td>
                  <div class="small">
                    <span class="text-muted">Desde:</span> {{ p.vigencia_desde|date:"d/M/Y" }}
                  </div>
                  <div class="small">
                    <span class="text-muted">Hasta:</span> {{ p.vigencia_hasta|date:"d/M/Y" }}
                  </div>
                </td>

                <td class="text-end">
                  <div class="fw-semibold">${{ p.prima_total|floatformat:2|intcomma }}</div>
                  <div class="text-muted small">{{ p.forma_pago|default:"" }}</div>
                </td>

                <td>
                  {% if p.estatus == "VIGENTE" %}
                    <span class="badge bg-success">Vigente</span>
                  {% elif p.estatus == "EN_PROCESO" %}
                    <span class="badge bg-warning text-dark">En proceso</span>
                  {% elif p.estatus == "VENCIDA" %}
                    <span class="badge bg-secondary">Vencida</span>
                  {% elif p.estatus == "CANCELADA" %}
                    <span class="badge bg-danger">Cancelada</span>
                  {% else %}
                    <span class="badge bg-light text-dark">{{ p.estatus }}</span>
                  {% endif %}
                </td>

                <td class="text-end pe-3">
                  <a class="btn btn-sm btn-outline-secondary py-0 px-2" style="font-size:.8rem;" href="{% url 'ui:poliza_detail' p.pk %}">
                    Ver
                  </a>
                  <!-- BOTON DOCUMENTO -->
                  {% if p.documento_id %}
                    <a class="btn btn-sm btn-outline-secondary py-0 px-2" style="font-size:.8rem;" href="">
                      Documento
                    </a>
                  {% endif %}
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>

      {% else %}
        <div class="p-4 text-center">
          <div class="display-6">üßæ</div>
          <h5 class="mt-2 mb-1">A√∫n no hay p√≥lizas</h5>
          <p class="text-muted mb-3">Crea una cotizaci√≥n, selecciona una opci√≥n y emite la p√≥liza.</p>
          <a href="{% url 'portal:cotizar' %}" class="btn btn-primary">
            <i class="bi bi-lightning-charge me-1"></i> Cotizar ahora
          </a>
        </div>
      {% endif %}

    </div>

    {% if is_paginated %}
      <div class="card-footer d-flex flex-wrap align-items-center justify-content-between gap-2">

        <div class="small text-muted">
          P√°gina {{ page_obj.number }} de {{ page_obj.paginator.num_pages }}
        </div>

        <nav aria-label="Paginaci√≥n">
          <ul class="pagination pagination-sm mb-0">

            {% with q=filters.q estatus=filters.estatus desde=filters.desde hasta=filters.hasta %}
              {% if page_obj.has_previous %}
                <li class="page-item">
                  <a class="page-link" href="?page=1&q={{ q|urlencode }}&estatus={{ estatus|urlencode }}&desde={{ desde|urlencode }}&hasta={{ hasta|urlencode }}">¬´</a>
                </li>
                <li class="page-item">
                  <a class="page-link" href="?page={{ page_obj.previous_page_number }}&q={{ q|urlencode }}&estatus={{ estatus|urlencode }}&desde={{ desde|urlencode }}&hasta={{ hasta|urlencode }}">Anterior</a>
                </li>
              {% else %}
                <li class="page-item disabled"><span class="page-link">¬´</span></li>
                <li class="page-item disabled"><span class="page-link">Anterior</span></li>
              {% endif %}

              <li class="page-item disabled">
                <span class="page-link">
                  {{ page_obj.number }}
                </span>
              </li>

              {% if page_obj.has_next %}
                <li class="page-item">
                  <a class="page-link" href="?page={{ page_obj.next_page_number }}&q={{ q|urlencode }}&estatus={{ estatus|urlencode }}&desde={{ desde|urlencode }}&hasta={{ hasta|urlencode }}">Siguiente</a>
                </li>
                <li class="page-item">
                  <a class="page-link" href="?page={{ page_obj.paginator.num_pages }}&q={{ q|urlencode }}&estatus={{ estatus|urlencode }}&desde={{ desde|urlencode }}&hasta={{ hasta|urlencode }}">¬ª</a>
                </li>
              {% else %}
                <li class="page-item disabled"><span class="page-link">Siguiente</span></li>
                <li class="page-item disabled"><span class="page-link">¬ª</span></li>
              {% endif %}
            {% endwith %}

          </ul>
        </nav>
      </div>
    {% endif %}
  </div>

</div>
{% endblock %}
