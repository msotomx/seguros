{% extends "ui/base.html" %}
{% block title %}Dashboard (Agente){% endblock %}

{% block content %}
<div class="d-flex align-items-center justify-content-between mb-3">
  <div>
    <h3 class="mb-0">Dashboard · Agente</h3>


    <div class="text-muted">
      Periodo: {{ kpi.period.start }} → {{ kpi.period.end|date:"Y-m-d" }} (exclusivo)
    </div>
  </div>
  <div class="d-flex gap-2">
    <a class="btn btn-outline-primary" href="{% url 'ui:cotizacion_new_cliente' %}">Nueva Cotización</a>
    <a class="btn btn-outline-primary" href="{% url 'ui:cotizacion_list' %}">Ver cotizaciones</a>
  </div>
</div>

<div class="row g-3 mb-4">
  <!-- Cotizaciones Pendientes -->
  <div class="col-12 col-md-3">
    <div class="card shadow-sm h-100">
        <div class="card-body position-relative">
            <div class="text-muted small"><strong>Cotizaciones pendientes</strong></div>
            <div class="fs-4 fw-bold">{{ kpi.counts.cot_pendientes }}</div>
            <div class="small text-muted">Borrador + Enviada</div>
            <a href="{% url 'ui:cotizacion_list' %}" class="stretched-link"></a>
        </div>
    </div>
  </div>
   
  <!-- Polizas Vigentes -->
  <div class="col-12 col-md-3">
    <div class="card shadow-sm border-success">
        <div class="card-body">
            <div class="text-muted small"><strong>Pólizas vigentes</strong></div>
            <div class="fs-4 fw-bold text-success">
                {{ kpi.counts.pol_vigentes }}
            </div>
            <div class="small text-success">
                Con cobertura activa
            </div>
            <a href="{% url 'ui:poliza_list' %}?estatus=VIGENTE" class="stretched-link" aria-label="Ver pólizas vigentes"></a>
        </div>
    </div>
  </div>
  <!-- Polizas por Vencer -->
  <div class="col-12 col-md-3">
    <div class="card shadow-sm border-warning">
      <div class="card-body">
        <div class="text-muted small"><strong>Pólizas por Vencer</strong></div>
        <div class="fs-4 fw-bold text-warning">{{ kpi.counts.pol_por_vencer }}</div>
        <div class="text-muted small">(30 días)</div>
        <a href="{% url 'ui:poliza_list' %}?estatus=VIGENTE&vencen=30" class="stretched-link"></a>
      </div>
    </div>
  </div>
  <!-- Pagos Vencidos -->
  <div class="col-12 col-md-3">
    <div class="card shadow-sm border-danger">
        <div class="card-body">
            <div class="text-muted small"><strong>Pagos vencidos</strong></div>
            <div class="fs-4 fw-bold text-danger">
                {{ kpi.counts.pagos_vencidos }}
            </div>
            <div class="small text-danger">Requieren atención</div>
            <a href="{% url 'ui:pago_list' %}?estatus=VENCIDO" class="stretched-link" aria-label="Ver pagos vencidos"></a>
        </div>
    </div>
  </div>

</div>

<div class="row g-3 mb-4">
  <!-- Cotizaciones del mes -->
  <div class="col-12 col-md-4">
    <div class="card shadow-sm">
      <div class="card-body">
        <div class="text-muted small"><strong>Cotizaciones del mes</strong></div>
        <div class="fs-4 fw-bold">
          {{ kpi.counts.cot_mes }}
        </div>
        <div class="small text-muted">
          Volumen generado
        </div>
      </div>
    </div>
  </div>

  <!-- Conversión del mes -->
  <div class="col-12 col-md-4">
    <div class="card shadow-sm border-info">
      <div class="card-body">
        <div class="text-muted small"><strong>Conversión del mes</strong></div>
        <div class="fs-4 fw-bold text-info">
          {{ kpi.rates.conversion_pct }}%
        </div>
        <div class="small text-muted">
          Pólizas emitidas este mes / Cotizaciones del mes
        </div>
      </div>
    </div>
  </div>

  <!-- Comisiones pendientes -->
  <div class="col-12 col-md-4">
    <div class="card shadow-sm border-success">
      <div class="card-body">
        <div class="text-muted small"><strong>Comisiones pendientes</strong></div>
        <div class="fs-4 fw-bold text-success">
          ${{ kpi.money.com_pendiente_total|floatformat:2 }}
        </div>
        <div class="small text-muted">
          Suma de comisiones en estatus PENDIENTE
        </div>
      </div>
    </div>
  </div>

</div>

<!-- Polizas por Vencer -->
<div class="card shadow-sm mb-4">
  <div class="card-body">
    <div class="d-flex justify-content-between align-items-center mb-2">
      <div class="text-muted small"><strong>Pólizas por vencer</strong></div>
      <a class="small text-decoration-none" href="{% url 'ui:poliza_list' %}?estatus=VIGENTE">Ver todas</a>
    </div>

    {% if kpi.lists.pol_por_vencer %}
      <div class="list-group list-group-flush">
        {% for p in kpi.lists.pol_por_vencer %}
          <a href="{% url 'ui:poliza_detail' p.pk %}" class="list-group-item list-group-item-action px-0">
            <div class="d-flex justify-content-between">
              <div>
                <div class="fw-semibold">{{ p.numero_poliza }}</div>
                <div class="text-muted small">{{ p.cliente }}</div>
              </div>
              <div class="text-end">
                <span class="badge bg-warning text-dark">
                  {{ p.vigencia_hasta|date:"d/M/Y" }}
                </span>
              </div>
            </div>
          </a>
        {% endfor %}
      </div>
    {% else %}
      <div class="text-muted small">No hay pólizas por vencer en los próximos 30 días.</div>
    {% endif %}
  </div>
</div>

<!-- Ultimas Cotizaciones -->
<div class="row g-3" ></div>
  <div class="col-12 col-xl-12">
    <div class="card shadow-sm my-3">
      <div class="card-body">
        <div class="text-muted small"><strong>Últimas cotizaciones</strong></div>
        <div class="table-responsive">
          <table class="table table-sm table-hover align-middle mb-0">
            <thead class="table-light">
              <hr>  
              <tr>
                <th>ID</th>
                <th>Cliente</th>
                <th>Tipo</th>
                <th>Estatus</th>
                <th class="text-end">Acción</th>
              </tr>
            </thead>
            <tbody>
              {% for c in kpi.lists.ult_cot %}
                <tr>
                  <td>#{{ c.id }}</td>
                  <td>{{ c.cliente }}</td>
                  <td>{{ c.get_tipo_cotizacion_display }}</td>
                  <td><span class="badge bg-secondary">{{ c.get_estatus_display }}</span></td>
                  <td class="text-end">
                    <a class="btn btn-sm btn-outline-primary" href="{% url 'ui:cotizacion_detail' pk=c.id %}">Abrir</a>
                  </td>
                </tr>
              {% empty %}
                <tr><td colspan="5" class="text-center text-muted py-3">Aún no hay cotizaciones.</td></tr>
              {% endfor %}
            </tbody>
          </table>
        </div>

        <div class="mt-2 text-muted small">
          Breakdown: Borrador={{ kpi.breakdown.BORRADOR|default:"0" }},
          Enviada={{ kpi.breakdown.ENVIADA|default:"0" }},
          Aceptada={{ kpi.breakdown.ACEPTADA|default:"0" }}
        </div>
      </div>
    </div>
  </div>

</div>

{% endblock %}
